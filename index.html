<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Scan Route Plan</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 420px;
      margin: 0 auto;
      padding: 16px;
    }

    h1 {
      font-size: 1.5rem;
      text-align: center;
      margin-bottom: 12px;
    }

    p {
      text-align: center;
      color: #555;
      margin-bottom: 20px;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }

    input[type="file"] {
      display: none;
    }

    label {
      display: block;
      width: 100%;
      padding: 14px;
      background: #2563eb;
      color: white;
      text-align: center;
      border-radius: 10px;
      font-size: 1rem;
      cursor: pointer;
    }

    .preview {
      margin-top: 16px;
      text-align: center;
    }

    .preview img {
      max-width: 100%;
      border-radius: 8px;
      border: 1px solid #ddd;
    }

    button {
      margin-top: 16px;
      width: 100%;
      padding: 14px;
      font-size: 1rem;
      border-radius: 10px;
      border: none;
      background: #16a34a;
      color: white;
      cursor: pointer;
    }

    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    /* Validation UI Styles */
    .validation-container { max-width: 1400px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
    .validation-header { text-align: center; margin-bottom: 30px; }
    .validation-title { color: #2c3e50; font-size: 28px; margin-bottom: 10px; }
    .validation-subtitle { color: #7f8c8d; font-size: 14px; }
    .summary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
    .summary-item { text-align: center; }
    .summary-number { font-size: 32px; font-weight: bold; display: block; }
    .summary-label { font-size: 13px; opacity: 0.9; }
    .actions-bar { background: #34495e; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 10px; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    .action-btn { padding: 12px 24px; border: none; border-radius: 5px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s; }
    .submit-btn { background: #27ae60; color: white; font-size: 16px; }
    .submit-btn:hover { background: #229954; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    .select-all-btn, .deselect-all-btn { background: #3498db; color: white; }
    .select-all-btn:hover, .deselect-all-btn:hover { background: #2980b9; }
    .export-json-btn { background: #9b59b6; color: white; }
    .export-json-btn:hover { background: #8e44ad; }
    .validation-stats { color: white; font-size: 14px; }
    .group { margin-bottom: 25px; border: 2px solid #3498db; border-radius: 8px; overflow: hidden; }
    .group-header { background: #3498db; color: white; padding: 15px; font-size: 20px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
    .group-stats { font-size: 14px; opacity: 0.9; }
    .street-section { padding: 15px; border-bottom: 1px solid #eee; }
    .street-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 8px; }
    .street-name { font-weight: bold; color: #2c3e50; font-size: 16px; }
    .street-actions { display: flex; gap: 8px; }
    .street-btn { padding: 6px 12px; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; background: #ecf0f1; color: #2c3e50; }
    .street-btn:hover { background: #bdc3c7; }
    .address-table { width: 100%; border-collapse: collapse; overflow-x: auto; display: block; }
    .address-table table { width: 100%; }
    .address-table th { background: #f8f9fa; padding: 10px; text-align: left; font-size: 13px; border-bottom: 2px solid #dee2e6; }
    .address-table td { padding: 10px; border-bottom: 1px solid #dee2e6; font-size: 13px; }
    .address-row { transition: background 0.2s; }
    .address-row:hover { background: #f8f9fa; }
    .address-row.invalid { opacity: 0.5; background: #fee; }
    .checkbox-cell { width: 40px; text-align: center; }
    .status-badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; }
    .status-rooftop { background: #d4edda; color: #155724; }
    .status-interpolated { background: #fff3cd; color: #856404; }
    .status-unknown { background: #e2e3e5; color: #383d41; }
    .coordinates { color: #666; font-size: 11px; font-family: monospace; }
    .map-link { color: #3498db; text-decoration: none; font-size: 12px; }
    .map-link:hover { text-decoration: underline; }
    input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
    .toast { position: fixed; top: 20px; right: 20px; background: #27ae60; color: white; padding: 15px 20px; border-radius: 5px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 1000; animation: slideIn 0.3s; }
    @keyframes slideIn { from { transform: translateX(400px); } to { transform: translateX(0); } }
    .route-map-btn { background: #e67e22; color: white; padding: 8px 16px; font-size: 14px; }
    .route-map-btn:hover { background: #d35400; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üì¶ Scan Route Plan</h1>
    <p>Take a clear photo of today's delivery sheet</p>

    <div class="card">
      <label for="photoInput">üì∑ Take Photo or Upload</label>
      <input 
        id="photoInput" 
        type="file" 
        accept="image/*" 
        capture="environment" 
      />

      <div class="preview" id="preview"></div>

      <button id="uploadBtn" disabled>üöÄ Process Route</button>
    </div>

    <div id="result" style="margin-top: 20px;"></div>
  </div>

  <script>
    console.log('JavaScript loaded successfully');
    
    const input = document.getElementById('photoInput');
    const preview = document.getElementById('preview');
    const uploadBtn = document.getElementById('uploadBtn');
    const resultDiv = document.getElementById('result');

    console.log('Elements found:', { input, preview, uploadBtn, resultDiv });

    input.addEventListener('change', () => {
      preview.innerHTML = '';
      resultDiv.innerHTML = '';
      const file = input.files[0];
      if (!file) return;

      const img = document.createElement('img');
      img.src = URL.createObjectURL(file);
      preview.appendChild(img);
      uploadBtn.disabled = false;
    });

    uploadBtn.addEventListener('click', async () => {
      console.log('Upload button clicked');
      const file = input.files[0];
      if (!file) {
        console.log('No file selected');
        return;
      }

      uploadBtn.disabled = true;
      uploadBtn.textContent = '‚è≥ Processing...';

      const formData = new FormData();
      formData.append('image', file);
      console.log('Sending request...');

      try {
        const response = await fetch('/webhook-test/upload-image', {
          method: 'POST',
          body: formData
        });

        console.log('Response received:', response.status, response.statusText);

        if (response.ok) {
          const contentType = response.headers.get('content-type');
          console.log('Response content-type:', contentType);
          
          const data = await response.json();
          console.log('Received data:', data);
          
          // Clear any existing content first
          resultDiv.innerHTML = '';
          
          // Render the interactive validation UI
          try {
            renderValidationUI(data);
          } catch (err) {
            console.error('Error rendering UI:', err);
            resultDiv.innerHTML = '<div style="background: #fee; color: #c00; padding: 20px; border-radius: 10px;">‚ùå Error rendering UI: ' + err.message + '</div>';
          }
          
          resultDiv.scrollIntoView({ behavior: 'smooth' });
        } else {
          resultDiv.innerHTML = '<div style="background: #fee; color: #c00; padding: 20px; border-radius: 10px;">‚ùå Upload failed. Please try again.</div>';
        }
      } catch (error) {
        resultDiv.innerHTML = '<div style="background: #fee; color: #c00; padding: 20px; border-radius: 10px;">‚ùå Error: ' + error.message + '</div>';
      } finally {
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'üöÄ Process Route';
      }
    });

    function renderValidationUI(data) {
      console.log('renderValidationUI called with:', data);
      
      if (!data || !data.groups || !data.summary) {
        console.error('Invalid data structure:', data);
        resultDiv.innerHTML = '<div style="background: #fee; color: #c00; padding: 20px; border-radius: 10px;">‚ùå Invalid data structure received</div>';
        return;
      }
      
      let html = `
        <div class="validation-container">
          <div class="validation-header">
            <h2 class="validation-title">üìç Delivery Route Address Validation</h2>
            <div class="validation-subtitle">Review and validate geocoded addresses. Uncheck invalid addresses before submitting.</div>
          </div>
          
          <div class="summary">
            <div class="summary-item"><span class="summary-number">${data.summary.totalGroups}</span><span class="summary-label">Groups</span></div>
            <div class="summary-item"><span class="summary-number">${data.summary.totalHouses}</span><span class="summary-label">Valid Addresses</span></div>
            <div class="summary-item"><span class="summary-number">${data.summary.rooftopAddresses || 0}</span><span class="summary-label">‚úì Confirmed</span></div>
            <div class="summary-item"><span class="summary-number">${data.summary.interpolatedAddresses || 0}</span><span class="summary-label">‚ö† Verify</span></div>
            <div class="summary-item"><span class="summary-number">${data.summary.notFound}</span><span class="summary-label">Not Found</span></div>
            <div class="summary-item"><span class="summary-number">${data.summary.discardedDueToProximity || 0}</span><span class="summary-label">Too Far</span></div>
          </div>
          
          <div class="actions-bar">
            <div style="display: flex; gap: 10px;">
              <button class="action-btn select-all-btn" onclick="selectAllAddresses()">‚úì Select All</button>
              <button class="action-btn deselect-all-btn" onclick="deselectAllAddresses()">‚úó Deselect All</button>
            </div>
            <div class="validation-stats">
              <span id="selectedCount">${data.summary.totalHouses}</span> addresses selected
            </div>
            <div style="display: flex; gap: 10px;">
              <button class="action-btn export-json-btn" onclick="exportValidatedJSON()">üì• Export JSON</button>
              <button class="action-btn submit-btn" onclick="submitValidation()">‚úì Submit Validated Addresses</button>
            </div>
          </div>
      `;
      
      data.groups.forEach(group => {
        const groupId = `group-${group.groupNumber}`;
        html += `
          <div class="group" id="${groupId}">
            <div class="group-header">
              <span>Group ${group.groupNumber} - ${group.totalHouses} Houses</span>
              <div style="display: flex; gap: 10px; align-items: center;">
                <button class="action-btn route-map-btn" onclick="generateRouteMap('${groupId}')">
                  üó∫Ô∏è Generate Route Map
                </button>
                <span class="group-stats">
                  <span id="${groupId}-selected">${group.totalHouses}</span> selected
                </span>
              </div>
            </div>
        `;
        
        group.streets.forEach((street, streetIdx) => {
          const streetId = `${groupId}-street-${streetIdx}`;
          html += `
            <div class="street-section">
              <div class="street-header">
                <div class="street-name">üèòÔ∏è ${street.streetName} (${street.addresses.length} houses)</div>
                <div class="street-actions">
                  <button class="street-btn" onclick="selectStreet('${streetId}')">‚úì Select All</button>
                  <button class="street-btn" onclick="deselectStreet('${streetId}')">‚úó Deselect All</button>
                </div>
              </div>
              <div class="address-table">
                <table id="${streetId}">
                  <thead>
                    <tr>
                      <th class="checkbox-cell">‚úì</th>
                      <th>House #</th>
                      <th>Full Address</th>
                      <th>Status</th>
                      <th>Coordinates</th>
                      <th>Map</th>
                    </tr>
                  </thead>
                  <tbody>
          `;
          
          street.addresses.forEach((addr, addrIdx) => {
            const addressId = `${streetId}-addr-${addrIdx}`;
            const coordText = addr.coordinates ? `${addr.coordinates.lat.toFixed(6)}, ${addr.coordinates.lng.toFixed(6)}` : 'No coords';
            const mapLink = addr.coordinates ? `https://www.google.com/maps?q=${addr.coordinates.lat},${addr.coordinates.lng}` : '#';
            
            let statusBadge = '<span class="status-badge status-unknown">Unknown</span>';
            if (addr.geocodeStatus === 'rooftop') {
              statusBadge = '<span class="status-badge status-rooftop">‚úì ROOFTOP</span>';
            } else if (addr.geocodeStatus === 'interpolated') {
              statusBadge = '<span class="status-badge status-interpolated">‚ö† INTERPOLATED</span>';
            }
            
            html += `
              <tr class="address-row" id="${addressId}" data-group="${group.groupNumber}" data-street="${street.streetName}">
                <td class="checkbox-cell">
                  <input type="checkbox" checked onchange="updateAddressCounts()" data-address='${JSON.stringify(addr).replace(/'/g, "&apos;")}'>
                </td>
                <td><strong>${addr.houseNumber}</strong></td>
                <td>${addr.fullAddress}</td>
                <td>${statusBadge}</td>
                <td class="coordinates">${coordText}</td>
                <td>${addr.coordinates ? `<a href="${mapLink}" target="_blank" class="map-link">View Map</a>` : '-'}</td>
              </tr>
            `;
          });
          
          html += `
                  </tbody>
                </table>
              </div>
            </div>
          `;
        });
        
        html += `</div>`;
      });
      
      html += `</div>`;
      
      resultDiv.innerHTML = html;
    }

    function updateAddressCounts() {
      const allCheckboxes = document.querySelectorAll('.validation-container input[type="checkbox"]');
      const checkedCount = Array.from(allCheckboxes).filter(cb => cb.checked).length;
      const selectedCountEl = document.getElementById('selectedCount');
      if (selectedCountEl) selectedCountEl.textContent = checkedCount;
      
      // Update group counts
      document.querySelectorAll('.group').forEach(group => {
        const groupId = group.id;
        const groupCheckboxes = group.querySelectorAll('input[type="checkbox"]');
        const groupChecked = Array.from(groupCheckboxes).filter(cb => cb.checked).length;
        const countElement = document.getElementById(groupId + '-selected');
        if (countElement) countElement.textContent = groupChecked;
      });
      
      // Update row styling
      allCheckboxes.forEach(cb => {
        const row = cb.closest('tr');
        if (row) {
          if (cb.checked) {
            row.classList.remove('invalid');
          } else {
            row.classList.add('invalid');
          }
        }
      });
    }

    function selectAllAddresses() {
      document.querySelectorAll('.validation-container input[type="checkbox"]').forEach(cb => cb.checked = true);
      updateAddressCounts();
    }

    function deselectAllAddresses() {
      document.querySelectorAll('.validation-container input[type="checkbox"]').forEach(cb => cb.checked = false);
      updateAddressCounts();
    }

    function selectStreet(streetId) {
      document.querySelectorAll('#' + streetId + ' input[type="checkbox"]').forEach(cb => cb.checked = true);
      updateAddressCounts();
    }

    function deselectStreet(streetId) {
      document.querySelectorAll('#' + streetId + ' input[type="checkbox"]').forEach(cb => cb.checked = false);
      updateAddressCounts();
    }

    function exportValidatedJSON() {
      const validatedData = getValidatedData();
      const json = JSON.stringify(validatedData, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'validated-addresses-' + new Date().toISOString().split('T')[0] + '.json';
      a.click();
      showToast('JSON exported successfully!');
    }

    function getValidatedData() {
      const groups = {};
      
      document.querySelectorAll('.validation-container input[type="checkbox"]:checked').forEach(cb => {
        const address = JSON.parse(cb.dataset.address);
        const row = cb.closest('tr');
        const groupNum = row.dataset.group;
        const streetName = row.dataset.street;
        
        if (!groups[groupNum]) {
          groups[groupNum] = { groupNumber: parseInt(groupNum), streets: {}, totalHouses: 0 };
        }
        
        if (!groups[groupNum].streets[streetName]) {
          groups[groupNum].streets[streetName] = { streetName: streetName, addresses: [] };
        }
        
        groups[groupNum].streets[streetName].addresses.push(address);
        groups[groupNum].totalHouses++;
      });
      
      const groupsArray = Object.values(groups).map(g => ({
        ...g,
        streets: Object.values(g.streets)
      }));
      
      return {
        groups: groupsArray,
        summary: {
          totalGroups: groupsArray.length,
          totalValidatedAddresses: Object.values(groups).reduce((sum, g) => sum + g.totalHouses, 0),
          validatedAt: new Date().toISOString()
        }
      };
    }

    function submitValidation() {
      const validatedData = getValidatedData();
      const totalSelected = validatedData.summary.totalValidatedAddresses;
      
      if (totalSelected === 0) {
        alert('‚ÑπÔ∏è No addresses selected! Please select at least one address.');
        return;
      }
      
      if (confirm(`Submit ${totalSelected} validated addresses?\n\nThis will finalize the address list.`)) {
        console.log('Validated Data:', validatedData);
        showToast(`‚úì ${totalSelected} addresses validated successfully!`);
        exportValidatedJSON();
      }
    }

    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function generateRouteMap(groupId) {
      const group = document.getElementById(groupId);
      const checkedCheckboxes = group.querySelectorAll('input[type="checkbox"]:checked');
      
      if (checkedCheckboxes.length === 0) {
        alert('‚ÑπÔ∏è No addresses selected in this group! Please select at least one address.');
        return;
      }
      
      const addresses = [];
      checkedCheckboxes.forEach(cb => {
        const address = JSON.parse(cb.dataset.address);
        if (address.coordinates && address.coordinates.lat && address.coordinates.lng) {
          addresses.push(address);
        }
      });
      
      if (addresses.length === 0) {
        alert('‚ÑπÔ∏è No valid coordinates found for selected addresses!');
        return;
      }
      
      if (addresses.length === 1) {
        const addr = addresses[0];
        const url = `https://www.google.com/maps?q=${addr.coordinates.lat},${addr.coordinates.lng}`;
        window.open(url, '_blank');
        showToast('Opening single address location...');
      } else {
        const origin = addresses[0];
        const destination = addresses[addresses.length - 1];
        const waypoints = addresses.slice(1, -1).map(a => `${a.coordinates.lat},${a.coordinates.lng}`).join('|');
        
        let url = `https://www.google.com/maps/dir/?api=1&origin=${origin.coordinates.lat},${origin.coordinates.lng}&destination=${destination.coordinates.lat},${destination.coordinates.lng}`;
        
        if (waypoints) {
          url += `&waypoints=${waypoints}`;
        }
        
        url += '&travelmode=walking';
        
        window.open(url, '_blank');
        showToast(`Opening route with ${addresses.length} stops...`);
      }
    }
  </script>
</body>
</html>
