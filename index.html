<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Scan Route Plan</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 420px;
      margin: 0 auto;
      padding: 16px;
    }

    h1 {
      font-size: 1.5rem;
      text-align: center;
      margin-bottom: 12px;
    }

    p {
      text-align: center;
      color: #555;
      margin-bottom: 20px;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }

    input[type="file"] {
      display: none;
    }

    label {
      display: block;
      width: 100%;
      padding: 14px;
      background: #2563eb;
      color: white;
      text-align: center;
      border-radius: 10px;
      font-size: 1rem;
      cursor: pointer;
    }

    .preview {
      margin-top: 16px;
      text-align: center;
    }

    .preview img {
      max-width: 100%;
      border-radius: 8px;
      border: 1px solid #ddd;
    }

    button {
      margin-top: 16px;
      width: 100%;
      padding: 14px;
      font-size: 1rem;
      border-radius: 10px;
      border: none;
      background: #16a34a;
      color: white;
      cursor: pointer;
    }

    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    /* Validation UI Styles */
    .validation-container { 
      max-width: 1400px; 
      width: 100%;
      margin: 0 auto; 
      background: white; 
      padding: 20px; 
      border-radius: 10px; 
      position: relative;
      left: 50%;
      right: 50%;
      margin-left: -50vw;
      margin-right: -50vw;
      width: 100vw;
      max-width: 100vw;
      box-sizing: border-box;
    }
    .validation-header { text-align: center; margin-bottom: 30px; }
    .validation-title { color: #2c3e50; font-size: 28px; margin-bottom: 10px; }
    .validation-subtitle { color: #7f8c8d; font-size: 14px; }
    .summary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
    .summary-item { text-align: center; }
    .summary-number { font-size: 32px; font-weight: bold; display: block; }
    .summary-label { font-size: 13px; opacity: 0.9; }
    .actions-bar { background: #34495e; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 10px; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    .action-btn { padding: 12px 24px; border: none; border-radius: 5px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s; }
    .submit-btn { background: #27ae60; color: white; font-size: 16px; }
    .submit-btn:hover { background: #229954; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    .select-all-btn, .deselect-all-btn { background: #3498db; color: white; }
    .select-all-btn:hover, .deselect-all-btn:hover { background: #2980b9; }
    .export-json-btn { background: #9b59b6; color: white; }
    .export-json-btn:hover { background: #8e44ad; }
    .validation-stats { color: white; font-size: 14px; }
    .group { margin-bottom: 25px; border: 2px solid #3498db; border-radius: 8px; overflow: hidden; }
    .group-header { background: #3498db; color: white; padding: 15px; font-size: 20px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
    .group-stats { font-size: 14px; opacity: 0.9; }
    .street-section { padding: 15px; border-bottom: 1px solid #eee; }
    .street-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 8px; }
    .street-name { font-weight: bold; color: #2c3e50; font-size: 16px; }
    .street-actions { display: flex; gap: 8px; }
    .street-btn { padding: 6px 12px; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; background: #ecf0f1; color: #2c3e50; }
    .street-btn:hover { background: #bdc3c7; }
    .address-table { width: 100%; border-collapse: collapse; overflow-x: auto; display: block; }
    .address-table table { width: 100%; }
    .address-table th { background: #f8f9fa; padding: 10px; text-align: left; font-size: 13px; border-bottom: 2px solid #dee2e6; }
    .address-table td { padding: 10px; border-bottom: 1px solid #dee2e6; font-size: 13px; }
    .address-row { transition: background 0.2s; }
    .address-row:hover { background: #f8f9fa; }
    .address-row.invalid { opacity: 0.5; background: #fee; }
    .address-row.interpolated-hidden { display: none; }
    .checkbox-cell { width: 40px; text-align: center; }
    .status-badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; }
    .status-rooftop { background: #d4edda; color: #155724; }
    .status-interpolated { background: #fff3cd; color: #856404; }
    .status-unknown { background: #e2e3e5; color: #383d41; }
    .toggle-interpolated-btn { background: #f39c12; color: white; }
    .toggle-interpolated-btn:hover { background: #e67e22; }
    .add-address-btn { background: #1abc9c; color: white; }
    .add-address-btn:hover { background: #16a085; }
    .edit-address-btn { background: #3498db; color: white; padding: 4px 8px; font-size: 11px; border: none; border-radius: 3px; cursor: pointer; }
    .edit-address-btn:hover { background: #2980b9; }
    .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
    .modal-content { background: white; margin: 5% auto; padding: 20px; border-radius: 10px; width: 90%; max-width: 500px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
    .modal-header { font-size: 20px; font-weight: bold; margin-bottom: 15px; color: #2c3e50; }
    .modal-footer { margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end; }
    .modal-input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
    .modal-btn { padding: 10px 20px; border: none; border-radius: 5px; font-size: 14px; cursor: pointer; }
    .modal-btn-primary { background: #27ae60; color: white; }
    .modal-btn-primary:hover { background: #229954; }
    .modal-btn-secondary { background: #95a5a6; color: white; }
    .modal-btn-secondary:hover { background: #7f8c8d; }
    .interpolated-count { color: #f39c12; font-weight: bold; }
    .coordinates { color: #666; font-size: 11px; font-family: monospace; }
    .map-link { color: #3498db; text-decoration: none; font-size: 12px; }
    .map-link:hover { text-decoration: underline; }
    input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
    .toast { position: fixed; top: 20px; right: 20px; background: #27ae60; color: white; padding: 15px 20px; border-radius: 5px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 1000; animation: slideIn 0.3s; }
    @keyframes slideIn { from { transform: translateX(400px); } to { transform: translateX(0); } }
    .route-map-btn { background: #e67e22; color: white; padding: 8px 16px; font-size: 14px; }
    .route-map-btn:hover { background: #d35400; }

    /* Mobile Responsive Styles */
    @media (max-width: 768px) {
      .validation-container {
        padding: 10px;
        margin-left: 0;
        margin-right: 0;
        left: 0;
        right: 0;
        width: 100%;
      }
      
      .validation-title {
        font-size: 20px !important;
      }
      
      .validation-subtitle {
        font-size: 12px !important;
      }
      
      .summary {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        padding: 15px;
      }
      
      .summary-number {
        font-size: 24px !important;
      }
      
      .summary-label {
        font-size: 11px !important;
      }
      
      .actions-bar {
        flex-direction: column;
        gap: 10px;
        padding: 10px;
      }
      
      .actions-bar > div {
        width: 100%;
      }
      
      .action-btn {
        padding: 10px 16px;
        font-size: 13px;
        width: 100%;
      }
      
      .group-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
        padding: 12px;
        font-size: 18px;
      }
      
      .group-header > div {
        width: 100%;
        justify-content: space-between;
      }
      
      .street-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .street-name {
        font-size: 14px !important;
        margin-bottom: 8px;
      }
      
      .street-section {
        padding: 10px;
      }
      
      .address-table {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      .address-table table {
        min-width: 600px;
      }
      
      .address-table th,
      .address-table td {
        padding: 8px;
        font-size: 12px;
      }
      
      .toast {
        right: 10px;
        top: 10px;
        left: 10px;
        padding: 12px 15px;
        font-size: 13px;
      }
    }

    @media (max-width: 480px) {
      .summary {
        grid-template-columns: 1fr;
      }
      
      .action-btn {
        padding: 8px 12px;
        font-size: 12px;
      }
      
      .street-actions {
        width: 100%;
      }
      
      .street-btn {
        flex: 1;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üì¶ Scan Route Plan</h1>
    <p>Take a clear photo of today's delivery sheet</p>

    <div class="card">
      <label for="photoInput">üì∑ Take Photo or Upload (Multiple Pages Supported)</label>
      <input 
        id="photoInput" 
        type="file" 
        accept="image/*" 
        capture="environment"
        multiple
      />

      <div class="preview" id="preview"></div>

      <button id="uploadBtn" disabled>üöÄ Process Route</button>
    </div>

    <div id="result" style="margin-top: 20px;"></div>
  </div>

  <script>
    console.log('JavaScript loaded successfully');
    
    const input = document.getElementById('photoInput');
    const preview = document.getElementById('preview');
    const uploadBtn = document.getElementById('uploadBtn');
    const resultDiv = document.getElementById('result');

    console.log('Elements found:', { input, preview, uploadBtn, resultDiv });

    input.addEventListener('change', () => {
      preview.innerHTML = '';
      resultDiv.innerHTML = '';
      const files = input.files;
      if (!files || files.length === 0) return;

      // Show all selected images
      for (let i = 0; i < files.length; i++) {
        const img = document.createElement('img');
        img.src = URL.createObjectURL(files[i]);
        img.style.marginBottom = '10px';
        preview.appendChild(img);
      }
      
      uploadBtn.disabled = false;
      uploadBtn.textContent = `üöÄ Process ${files.length} Page${files.length > 1 ? 's' : ''}`;
    });

    uploadBtn.addEventListener('click', async () => {
      console.log('Upload button clicked');
      const files = input.files;
      if (!files || files.length === 0) {
        console.log('No files selected');
        return;
      }

      uploadBtn.disabled = true;
      const totalFiles = files.length;
      let processedFiles = 0;

      // Show progress
      resultDiv.innerHTML = `<div style="background: #d4edda; color: #155724; padding: 20px; border-radius: 10px; text-align: center;">
        ‚è≥ Processing ${totalFiles} page${totalFiles > 1 ? 's' : ''}... (0/${totalFiles})
      </div>`;

      console.log(`Processing ${totalFiles} files...`);

      try {
        const allResults = [];

        // Process each file sequentially
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          console.log(`Processing file ${i + 1}/${totalFiles}:`, file.name);
          
          // Update progress
          resultDiv.innerHTML = `<div style="background: #d4edda; color: #155724; padding: 20px; border-radius: 10px; text-align: center;">
            ‚è≥ Processing page ${i + 1}/${totalFiles}...<br>
            <small>${file.name}</small>
          </div>`;

          const formData = new FormData();
          formData.append('image', file);

          const response = await fetch('/webhook-test/upload-image', {
            method: 'POST',
            body: formData
          });

          console.log(`Response for file ${i + 1}:`, response.status, response.statusText);

          if (response.ok) {
            const contentType = response.headers.get('content-type');
            console.log('Response content-type:', contentType);
            
            const data = await response.json();
            console.log(`Received data for file ${i + 1}:`, data);
            
            allResults.push(data);
            processedFiles++;
          } else {
            console.error(`Failed to process file ${i + 1}`);
            allResults.push(null);
          }
        }

        console.log('All results:', allResults);

        // Filter out failed results
        const validResults = allResults.filter(r => r !== null);

        if (validResults.length === 0) {
          resultDiv.innerHTML = '<div style="background: #fee; color: #c00; padding: 20px; border-radius: 10px;">‚ùå Failed to process any images. Please try again.</div>';
          return;
        }

        // Merge all results
        const mergedData = mergeResults(validResults);
        console.log('Merged data:', mergedData);

        // Clear and render
        resultDiv.innerHTML = '';
        
        try {
          renderValidationUI(mergedData);
        } catch (err) {
          console.error('Error rendering UI:', err);
          resultDiv.innerHTML = '<div style="background: #fee; color: #c00; padding: 20px; border-radius: 10px;">‚ùå Error rendering UI: ' + err.message + '</div>';
        }
        
        resultDiv.scrollIntoView({ behavior: 'smooth' });
      } catch (error) {
        console.error('Error processing files:', error);
        resultDiv.innerHTML = '<div style="background: #fee; color: #c00; padding: 20px; border-radius: 10px;">‚ùå Error: ' + error.message + '</div>';
      } finally {
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'üöÄ Process Route';
      }
    });

    // Function to merge multiple results into one
    function mergeResults(results) {
      console.log('Merging results:', results);
      
      const mergedGroups = {};
      const summary = {
        totalGroups: 0,
        totalCandidates: 0,
        totalHouses: 0,
        geocodedHouses: 0,
        rooftopAddresses: 0,
        interpolatedAddresses: 0,
        notFound: 0,
        discardedDueToProximity: 0
      };

      // Merge all groups from all results
      results.forEach(result => {
        if (!result || !result.groups) return;

        result.groups.forEach(group => {
          const groupKey = group.groupNumber;
          
          if (!mergedGroups[groupKey]) {
            mergedGroups[groupKey] = {
              groupNumber: group.groupNumber,
              streets: {},
              totalHouses: 0
            };
          }

          // Merge streets
          group.streets.forEach(street => {
            const streetKey = street.streetName;
            
            if (!mergedGroups[groupKey].streets[streetKey]) {
              mergedGroups[groupKey].streets[streetKey] = {
                streetName: street.streetName,
                addresses: []
              };
            }

            // Add addresses (avoiding duplicates based on house number)
            street.addresses.forEach(addr => {
              const exists = mergedGroups[groupKey].streets[streetKey].addresses.some(
                a => a.houseNumber === addr.houseNumber
              );
              
              if (!exists) {
                mergedGroups[groupKey].streets[streetKey].addresses.push(addr);
                mergedGroups[groupKey].totalHouses++;
              }
            });
          });
        });

        // Merge summary
        if (result.summary) {
          summary.totalCandidates += result.summary.totalCandidates || 0;
          summary.totalHouses += result.summary.totalHouses || 0;
          summary.geocodedHouses += result.summary.geocodedHouses || 0;
          summary.rooftopAddresses += result.summary.rooftopAddresses || 0;
          summary.interpolatedAddresses += result.summary.interpolatedAddresses || 0;
          summary.notFound += result.summary.notFound || 0;
          summary.discardedDueToProximity += result.summary.discardedDueToProximity || 0;
        }
      });

      // Convert to array and sort addresses
      const groupsArray = Object.values(mergedGroups).map(group => ({
        ...group,
        streets: Object.values(group.streets).map(street => ({
          ...street,
          addresses: street.addresses.sort((a, b) => a.houseNumber - b.houseNumber)
        }))
      })).sort((a, b) => a.groupNumber - b.groupNumber);

      summary.totalGroups = groupsArray.length;

      return {
        groups: groupsArray,
        summary: summary
      };
    }

    function renderValidationUI(data) {
      console.log('renderValidationUI called with:', data);
      
      if (!data || !data.groups || !data.summary) {
        console.error('Invalid data structure:', data);
        resultDiv.innerHTML = '<div style="background: #fee; color: #c00; padding: 20px; border-radius: 10px;">‚ùå Invalid data structure received</div>';
        return;
      }
      
      let html = `
        <div class="validation-container">
          <div class="validation-header">
            <h2 class="validation-title">üìç Delivery Route Address Validation</h2>
            <div class="validation-subtitle">Review and validate geocoded addresses. Uncheck invalid addresses before submitting.</div>
          </div>
          
          <div class="summary">
            <div class="summary-item"><span class="summary-number">${data.summary.totalGroups}</span><span class="summary-label">Groups</span></div>
            <div class="summary-item"><span class="summary-number">${data.summary.totalHouses}</span><span class="summary-label">Valid Addresses</span></div>
            <div class="summary-item"><span class="summary-number">${data.summary.rooftopAddresses || 0}</span><span class="summary-label">‚úì Confirmed</span></div>
            <div class="summary-item"><span class="summary-number">${data.summary.interpolatedAddresses || 0}</span><span class="summary-label">‚ö† Verify</span></div>
            <div class="summary-item"><span class="summary-number">${data.summary.notFound}</span><span class="summary-label">Not Found</span></div>
            <div class="summary-item"><span class="summary-number">${data.summary.discardedDueToProximity || 0}</span><span class="summary-label">Too Far</span></div>
          </div>
          
          <div class="actions-bar">
            <div style="display: flex; gap: 10px;">
              <button class="action-btn select-all-btn" onclick="selectAllAddresses()">‚úì Select All</button>
              <button class="action-btn deselect-all-btn" onclick="deselectAllAddresses()">‚úó Deselect All</button>
            </div>
            <div class="validation-stats">
              <span id="selectedCount">${data.summary.totalHouses}</span> addresses selected
            </div>
            <div style="display: flex; gap: 10px;">
              <button class="action-btn export-json-btn" onclick="exportValidatedJSON()">üì• Export JSON</button>
              <button class="action-btn submit-btn" onclick="submitValidation()">‚úì Submit Validated Addresses</button>
            </div>
          </div>
      `;
      
      data.groups.forEach(group => {
        const groupId = `group-${group.groupNumber}`;
        const confirmedCount = group.streets.reduce((sum, street) => 
          sum + street.addresses.filter(a => a.geocodeStatus === 'rooftop').length, 0);
        const interpolatedCount = group.streets.reduce((sum, street) => 
          sum + street.addresses.filter(a => a.geocodeStatus === 'interpolated').length, 0);
        
        html += `
          <div class="group" id="${groupId}">
            <div class="group-header">
              <span>Group ${group.groupNumber} - <span id="${groupId}-confirmed-count">${confirmedCount}</span> Confirmed (<span class="interpolated-count" id="${groupId}-interpolated-count">${interpolatedCount}</span> Verify)</span>
              <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <button class="action-btn toggle-interpolated-btn" onclick="toggleInterpolated('${groupId}')" id="${groupId}-toggle-btn">
                  üëÅÔ∏è Show ${interpolatedCount} Unverified
                </button>
                <button class="action-btn add-address-btn" onclick="showAddAddressModal('${groupId}', ${group.groupNumber})">
                  ‚ûï Add Address
                </button>
                <button class="action-btn route-map-btn" onclick="generateRouteMap('${groupId}')">
                  üó∫Ô∏è Generate Route Map
                </button>
                <span class="group-stats">
                  <span id="${groupId}-selected">${confirmedCount}</span> selected
                </span>
              </div>
            </div>
        `;
        
        group.streets.forEach((street, streetIdx) => {
          const streetId = `${groupId}-street-${streetIdx}`;
          html += `
            <div class="street-section">
              <div class="street-header">
                <div class="street-name">üèòÔ∏è ${street.streetName} (${street.addresses.length} houses)</div>
                <div class="street-actions">
                  <button class="street-btn" onclick="selectStreet('${streetId}')">‚úì Select All</button>
                  <button class="street-btn" onclick="deselectStreet('${streetId}')">‚úó Deselect All</button>
                </div>
              </div>
              <div class="address-table">
                <table id="${streetId}">
                  <thead>
                    <tr>
                      <th class="checkbox-cell">‚úì</th>
                      <th>House #</th>
                      <th>Full Address</th>
                      <th>Status</th>
                      <th>Coordinates</th>
                      <th>Map</th>
                    </tr>
                  </thead>
                  <tbody>
          `;
          
          street.addresses.forEach((addr, addrIdx) => {
            const addressId = `${streetId}-addr-${addrIdx}`;
            const coordText = addr.coordinates ? `${addr.coordinates.lat.toFixed(6)}, ${addr.coordinates.lng.toFixed(6)}` : 'No coords';
            const mapLink = addr.coordinates ? `https://www.google.com/maps?q=${addr.coordinates.lat},${addr.coordinates.lng}` : '#';
            
            let statusBadge = '<span class="status-badge status-unknown">Unknown</span>';
            let rowClass = 'address-row';
            let isChecked = 'checked';
            
            if (addr.geocodeStatus === 'rooftop') {
              statusBadge = '<span class="status-badge status-rooftop">‚úì ROOFTOP</span>';
            } else if (addr.geocodeStatus === 'interpolated') {
              statusBadge = '<span class="status-badge status-interpolated">‚ö† INTERPOLATED</span>';
              rowClass = 'address-row interpolated-hidden';
              isChecked = '';
            }
            
            html += `
              <tr class="${rowClass}" id="${addressId}" data-group="${group.groupNumber}" data-street="${street.streetName}" data-status="${addr.geocodeStatus || 'unknown'}">
                <td class="checkbox-cell">
                  <input type="checkbox" ${isChecked} onchange="updateAddressCounts()" data-address='${JSON.stringify(addr).replace(/'/g, "&apos;")}'>
                </td>
                <td><strong>${addr.houseNumber}</strong></td>
                <td>${addr.fullAddress}</td>
                <td>${statusBadge}</td>
                <td class="coordinates">${coordText}</td>
                <td>
                  ${addr.coordinates ? `<a href="${mapLink}" target="_blank" class="map-link">View Map</a>` : '-'}
                  <button class="edit-address-btn" onclick="showEditAddressModal('${addressId}', '${groupId}')">‚úèÔ∏è Edit</button>
                </td>
              </tr>
            `;
          });
          
          html += `
                  </tbody>
                </table>
              </div>
            </div>
          `;
        });
        
        html += `</div>`;
      });
      
      // Add modal for adding/editing addresses
      html += `
        <div id="addressModal" class="modal">
          <div class="modal-content">
            <div class="modal-header" id="modalTitle">Add Address</div>
            <input type="hidden" id="modalGroupId">
            <input type="hidden" id="modalAddressId">
            <input type="hidden" id="modalGroupNumber">
            <input type="number" class="modal-input" id="modalHouseNumber" placeholder="House Number (e.g., 503)">
            <input type="text" class="modal-input" id="modalStreetName" placeholder="Street Name (e.g., HILLCREST PT NW)">
            <input type="text" class="modal-input" id="modalCity" placeholder="City" value="Edmonton">
            <input type="text" class="modal-input" id="modalProvince" placeholder="Province" value="AB">
            <input type="text" class="modal-input" id="modalCountry" placeholder="Country" value="Canada">
            <div class="modal-footer">
              <button class="modal-btn modal-btn-secondary" onclick="closeAddressModal()">Cancel</button>
              <button class="modal-btn modal-btn-primary" onclick="saveAddress()">Save</button>
            </div>
          </div>
        </div>
      `;
      
      html += `</div>`;
      
      resultDiv.innerHTML = html;
    }

    function updateAddressCounts() {
      const allCheckboxes = document.querySelectorAll('.validation-container input[type="checkbox"]');
      const checkedCount = Array.from(allCheckboxes).filter(cb => cb.checked).length;
      const selectedCountEl = document.getElementById('selectedCount');
      if (selectedCountEl) selectedCountEl.textContent = checkedCount;
      
      // Update group counts
      document.querySelectorAll('.group').forEach(group => {
        const groupId = group.id;
        const groupCheckboxes = group.querySelectorAll('input[type="checkbox"]');
        const groupChecked = Array.from(groupCheckboxes).filter(cb => cb.checked).length;
        const countElement = document.getElementById(groupId + '-selected');
        if (countElement) countElement.textContent = groupChecked;
      });
      
      // Update row styling
      allCheckboxes.forEach(cb => {
        const row = cb.closest('tr');
        if (row) {
          if (cb.checked) {
            row.classList.remove('invalid');
          } else {
            row.classList.add('invalid');
          }
        }
      });
    }

    function selectAllAddresses() {
      document.querySelectorAll('.validation-container input[type="checkbox"]').forEach(cb => cb.checked = true);
      updateAddressCounts();
    }

    function deselectAllAddresses() {
      document.querySelectorAll('.validation-container input[type="checkbox"]').forEach(cb => cb.checked = false);
      updateAddressCounts();
    }

    function selectStreet(streetId) {
      document.querySelectorAll('#' + streetId + ' input[type="checkbox"]').forEach(cb => cb.checked = true);
      updateAddressCounts();
    }

    function deselectStreet(streetId) {
      document.querySelectorAll('#' + streetId + ' input[type="checkbox"]').forEach(cb => cb.checked = false);
      updateAddressCounts();
    }

    function exportValidatedJSON() {
      const validatedData = getValidatedData();
      const json = JSON.stringify(validatedData, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'validated-addresses-' + new Date().toISOString().split('T')[0] + '.json';
      a.click();
      showToast('JSON exported successfully!');
    }

    function getValidatedData() {
      const groups = {};
      
      document.querySelectorAll('.validation-container input[type="checkbox"]:checked').forEach(cb => {
        const address = JSON.parse(cb.dataset.address);
        const row = cb.closest('tr');
        const groupNum = row.dataset.group;
        const streetName = row.dataset.street;
        
        if (!groups[groupNum]) {
          groups[groupNum] = { groupNumber: parseInt(groupNum), streets: {}, totalHouses: 0 };
        }
        
        if (!groups[groupNum].streets[streetName]) {
          groups[groupNum].streets[streetName] = { streetName: streetName, addresses: [] };
        }
        
        groups[groupNum].streets[streetName].addresses.push(address);
        groups[groupNum].totalHouses++;
      });
      
      const groupsArray = Object.values(groups).map(g => ({
        ...g,
        streets: Object.values(g.streets)
      }));
      
      return {
        groups: groupsArray,
        summary: {
          totalGroups: groupsArray.length,
          totalValidatedAddresses: Object.values(groups).reduce((sum, g) => sum + g.totalHouses, 0),
          validatedAt: new Date().toISOString()
        }
      };
    }

    function submitValidation() {
      const validatedData = getValidatedData();
      const totalSelected = validatedData.summary.totalValidatedAddresses;
      
      if (totalSelected === 0) {
        alert('‚ÑπÔ∏è No addresses selected! Please select at least one address.');
        return;
      }
      
      if (confirm(`Submit ${totalSelected} validated addresses?\n\nThis will finalize the address list.`)) {
        console.log('Validated Data:', validatedData);
        showToast(`‚úì ${totalSelected} addresses validated successfully!`);
        exportValidatedJSON();
      }
    }

    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function generateRouteMap(groupId) {
      const group = document.getElementById(groupId);
      // Only get checkboxes from visible rows (not hidden interpolated ones)
      const visibleRows = group.querySelectorAll('.address-row:not(.interpolated-hidden)');
      
      console.log(`Total visible rows in ${groupId}:`, visibleRows.length);
      
      if (visibleRows.length === 0) {
        alert('‚ÑπÔ∏è No visible addresses in this group!');
        return;
      }
      
      // Collect addresses and ensure uniqueness by house number
      const addressMap = new Map();
      visibleRows.forEach((row, index) => {
        const checkbox = row.querySelector('input[type="checkbox"]');
        if (!checkbox || !checkbox.checked) {
          return;
        }
        
        try {
          const address = JSON.parse(checkbox.dataset.address);
          console.log(`Row ${index}: ${address.houseNumber} ${address.streetName}, checked: ${checkbox.checked}, coords: ${address.coordinates ? 'yes' : 'no'}`);
          
          if (address.coordinates && address.coordinates.lat && address.coordinates.lng) {
            // Use house number + street name + coordinates as unique key to avoid duplicates
            const key = `${address.streetName}-${address.houseNumber}-${address.coordinates.lat}`;
            if (!addressMap.has(key)) {
              addressMap.set(key, address);
            } else {
              console.warn(`Duplicate found and skipped: ${address.houseNumber} ${address.streetName}`);
            }
          }
        } catch (err) {
          console.error('Error parsing address from checkbox:', err);
        }
      });
      
      const addresses = Array.from(addressMap.values());
      console.log(`Unique addresses collected: ${addresses.length}`);
      
      if (addresses.length === 0) {
        alert('‚ÑπÔ∏è No valid coordinates found for selected addresses!');
        return;
      }
      
      // Sort addresses by street name first, then by house number for logical route order
      addresses.sort((a, b) => {
        if (a.streetName !== b.streetName) {
          return a.streetName.localeCompare(b.streetName);
        }
        return a.houseNumber - b.houseNumber;
      });
      
      console.log('Route addresses (sorted):', addresses.map(a => `${a.houseNumber} ${a.streetName}`));
      
      if (addresses.length === 1) {
        const addr = addresses[0];
        const url = `https://www.google.com/maps?q=${addr.coordinates.lat},${addr.coordinates.lng}`;
        window.open(url, '_blank');
        showToast('Opening single address location...');
      } else {
        const origin = addresses[0];
        const destination = addresses[addresses.length - 1];
        const waypoints = addresses.slice(1, -1).map(a => `${a.coordinates.lat},${a.coordinates.lng}`).join('|');
        
        let url = `https://www.google.com/maps/dir/?api=1&origin=${origin.coordinates.lat},${origin.coordinates.lng}&destination=${destination.coordinates.lat},${destination.coordinates.lng}`;
        
        if (waypoints) {
          url += `&waypoints=${waypoints}`;
        }
        
        url += '&travelmode=walking';
        
        window.open(url, '_blank');
        showToast(`Opening route with ${addresses.length} stops...`);
      }
    }

    function toggleInterpolated(groupId) {
      const group = document.getElementById(groupId);
      const interpolatedRows = group.querySelectorAll('.address-row[data-status="interpolated"]');
      const toggleBtn = document.getElementById(groupId + '-toggle-btn');
      const isHidden = interpolatedRows[0]?.classList.contains('interpolated-hidden');
      
      interpolatedRows.forEach(row => {
        if (isHidden) {
          row.classList.remove('interpolated-hidden');
        } else {
          row.classList.add('interpolated-hidden');
          // Uncheck hidden addresses
          const checkbox = row.querySelector('input[type="checkbox"]');
          if (checkbox) checkbox.checked = false;
        }
      });
      
      toggleBtn.textContent = isHidden ? 'üëÅÔ∏è Hide Unverified' : `üëÅÔ∏è Show ${interpolatedRows.length} Unverified`;
      updateAddressCounts();
    }

    function showAddAddressModal(groupId, groupNumber) {
      document.getElementById('modalTitle').textContent = 'Add Address to Group ' + groupNumber;
      document.getElementById('modalGroupId').value = groupId;
      document.getElementById('modalGroupNumber').value = groupNumber;
      document.getElementById('modalAddressId').value = '';
      document.getElementById('modalHouseNumber').value = '';
      document.getElementById('modalStreetName').value = '';
      document.getElementById('modalCity').value = 'Edmonton';
      document.getElementById('modalProvince').value = 'AB';
      document.getElementById('modalCountry').value = 'Canada';
      document.getElementById('addressModal').style.display = 'block';
    }

    function showEditAddressModal(addressId, groupId) {
      const row = document.getElementById(addressId);
      const checkbox = row.querySelector('input[type="checkbox"]');
      const addr = JSON.parse(checkbox.dataset.address);
      
      document.getElementById('modalTitle').textContent = 'Edit Address';
      document.getElementById('modalGroupId').value = groupId;
      document.getElementById('modalAddressId').value = addressId;
      document.getElementById('modalGroupNumber').value = addr.groupNumber;
      document.getElementById('modalHouseNumber').value = addr.houseNumber;
      
      // Extract street name from full address
      const addressParts = addr.fullAddress.split(',');
      const streetPart = addressParts[0].trim().replace(/^\d+\s+/, '');
      document.getElementById('modalStreetName').value = streetPart;
      document.getElementById('modalCity').value = addressParts[1]?.trim() || 'Edmonton';
      document.getElementById('modalProvince').value = addressParts[2]?.trim() || 'AB';
      document.getElementById('modalCountry').value = addressParts[3]?.trim() || 'Canada';
      
      document.getElementById('addressModal').style.display = 'block';
    }

    function closeAddressModal() {
      document.getElementById('addressModal').style.display = 'none';
    }

    async function saveAddress() {
      const groupId = document.getElementById('modalGroupId').value;
      const addressId = document.getElementById('modalAddressId').value;
      const groupNumber = parseInt(document.getElementById('modalGroupNumber').value);
      const houseNumber = parseInt(document.getElementById('modalHouseNumber').value);
      const streetName = document.getElementById('modalStreetName').value.trim().toUpperCase();
      const city = document.getElementById('modalCity').value.trim();
      const province = document.getElementById('modalProvince').value.trim();
      const country = document.getElementById('modalCountry').value.trim();
      
      if (!houseNumber || !streetName) {
        alert('Please enter house number and street name');
        return;
      }
      
      const fullAddress = `${houseNumber} ${streetName}, ${city}, ${province}, ${country}`;
      
      // Create new address object
      const newAddress = {
        groupNumber: groupNumber,
        streetName: streetName,
        houseNumber: houseNumber,
        fullAddress: fullAddress,
        coordinates: null,
        geocodeStatus: 'manual',
        exists: true
      };
      
      // If editing, update existing row
      if (addressId) {
        const row = document.getElementById(addressId);
        const checkbox = row.querySelector('input[type="checkbox"]');
        checkbox.dataset.address = JSON.stringify(newAddress);
        
        row.cells[1].innerHTML = `<strong>${houseNumber}</strong>`;
        row.cells[2].textContent = fullAddress;
        row.cells[3].innerHTML = '<span class="status-badge" style="background: #3498db; color: white;">‚úèÔ∏è MANUAL</span>';
        row.cells[4].textContent = 'Manual entry';
        row.cells[5].innerHTML = '<button class="edit-address-btn" onclick="showEditAddressModal(\'' + addressId + '\', \'' + groupId + '\')">‚úèÔ∏è Edit</button>';
        
        showToast('Address updated successfully!');
      } else {
        // If adding new, find the right street table or create new street section
        const group = document.getElementById(groupId);
        let streetSection = null;
        
        // Find existing street section
        group.querySelectorAll('.street-section').forEach(section => {
          const streetNameEl = section.querySelector('.street-name');
          if (streetNameEl && streetNameEl.textContent.includes(streetName)) {
            streetSection = section;
          }
        });
        
        // If street doesn't exist, create new street section
        if (!streetSection) {
          const newStreetHtml = `
            <div class="street-section">
              <div class="street-header">
                <div class="street-name">üèòÔ∏è ${streetName} (1 houses)</div>
                <div class="street-actions">
                  <button class="street-btn" onclick="selectStreet('${groupId}-street-new-${Date.now()}')">‚úì Select All</button>
                  <button class="street-btn" onclick="deselectStreet('${groupId}-street-new-${Date.now()}')">‚úó Deselect All</button>
                </div>
              </div>
              <div class="address-table">
                <table id="${groupId}-street-new-${Date.now()}">
                  <thead>
                    <tr>
                      <th class="checkbox-cell">‚úì</th>
                      <th>House #</th>
                      <th>Full Address</th>
                      <th>Status</th>
                      <th>Coordinates</th>
                      <th>Map</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          `;
          group.querySelector('.group-header').insertAdjacentHTML('afterend', newStreetHtml);
          streetSection = group.querySelector('.street-section:last-of-type');
        }
        
        // Add new row to the table
        const table = streetSection.querySelector('tbody');
        const newRowId = `${groupId}-addr-new-${Date.now()}`;
        const newRow = `
          <tr class="address-row" id="${newRowId}" data-group="${groupNumber}" data-street="${streetName}" data-status="manual">
            <td class="checkbox-cell">
              <input type="checkbox" checked onchange="updateAddressCounts()" data-address='${JSON.stringify(newAddress).replace(/'/g, "&apos;")}'>
            </td>
            <td><strong>${houseNumber}</strong></td>
            <td>${fullAddress}</td>
            <td><span class="status-badge" style="background: #3498db; color: white;">‚úèÔ∏è MANUAL</span></td>
            <td class="coordinates">Manual entry</td>
            <td><button class="edit-address-btn" onclick="showEditAddressModal('${newRowId}', '${groupId}')">‚úèÔ∏è Edit</button></td>
          </tr>
        `;
        table.insertAdjacentHTML('beforeend', newRow);
        
        showToast('Address added successfully!');
      }
      
      closeAddressModal();
      updateAddressCounts();
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('addressModal');
      if (event.target == modal) {
        closeAddressModal();
      }
    }
  </script>
</body>
</html>
